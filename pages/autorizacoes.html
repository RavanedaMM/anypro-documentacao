<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autoriza√ß√µes - ANYPRO</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Sistema de Autoriza√ß√µes</h1>
            <div class="subtitle">RBAC, Perfis e Controle Granular de Permiss√µes</div>
        </div>
        
        <div class="breadcrumb">
            <a href="../index.html">üè† Home</a>
            <span>‚Ä∫</span>
            <span>Autoriza√ß√µes</span>
        </div>
        
        <div class="nav">
            <ul class="nav-links">
                <li><a href="visao-geral.html">üéØ Vis√£o Geral</a></li>
                <li><a href="casos-uso.html">üìã Requisitos</a></li>
                <li><a href="arquitetura.html">üèóÔ∏è Arquitetura</a></li>
                <li><a href="banco-dados.html">üóÑÔ∏è Banco de Dados</a></li>
                <li><a href="autorizacoes.html">üîê Seguran√ßa</a></li>
                <li><a href="modulos.html">üì¶ M√≥dulos</a></li>
                <li><a href="apis.html">üîå APIs</a></li>
                <li><a href="ux-acessibilidade.html">‚ôø UX</a></li>
                <li><a href="design-system.html">üé® Design</a></li>
                <li><a href="operacoes.html">‚öôÔ∏è Opera√ß√µes</a></li>
                <li><a href="testes.html">üß™ Testes</a></li>
                <li><a href="sistema-sis.html">üîß Bootstrap</a></li>
                <li><a href="roadmap.html">üóìÔ∏è Roadmap</a></li>
                <li><a href="contribuir.html">ü§ù Contribuir</a></li>
                <li><a href="referencias.html">üìö Refer√™ncias</a></li>
                <li><a href="glossario.html">üìñ Gloss√°rio</a></li>
            </ul>
        </div>
        
        <div class="content">
            <h2>üìò Introdu√ß√£o</h2>
            <h3>üéØ Vis√£o Geral</h3>
            <div class="info-box">
                <p>O ANYPRO implementa um sistema robusto de <strong>Role-Based Access Control (RBAC)</strong> com controle granular de permiss√µes em tr√™s n√≠veis:</p>
                <ul>
                    <li>‚úÖ <strong>N√≠vel de M√≥dulo:</strong> Controle de acesso aos m√≥dulos do sistema (ADM, SUP, FIN, etc)</li>
                    <li>‚úÖ <strong>N√≠vel de Tela:</strong> Controle de acesso √†s telas dentro de cada m√≥dulo</li>
                    <li>‚úÖ <strong>N√≠vel de A√ß√£o:</strong> Controle de opera√ß√µes espec√≠ficas (Criar, Ler, Atualizar, Excluir, Aprovar, Cancelar, Exportar)</li>
                </ul>
                
                <p>Com mais de <strong>999+ autoriza√ß√µes</strong> dispon√≠veis, o sistema permite configurar perfis de acesso extremamente personalizados para cada tipo de usu√°rio.</p>
            </div>
            
            <h2>üõ†Ô∏è Como Fazer</h2>
            <h3>üë§ Criar um Novo Perfil de Acesso</h3>
            <div class="info-box">
                <ol>
                    <li>Acesse <strong>ADM ‚Üí Perfis de Acesso</strong></li>
                    <li>Clique em <strong>Novo Perfil</strong></li>
                    <li>Informe nome e descri√ß√£o (ex: "Vendedor J√∫nior")</li>
                    <li>Selecione as autoriza√ß√µes por m√≥dulo/tela/a√ß√£o</li>
                    <li>Defina se herda de outro perfil (opcional)</li>
                    <li>Salve e associe aos usu√°rios desejados</li>
                </ol>
            </div>

            <h3>üîë Implementar Autoriza√ß√£o em Endpoint</h3>
            <div class="code-block">// API/Controllers/ProdutoController.cs
[Authorize]
[ApiController]
[Route("api/v1/[controller]")]
public class ProdutoController : ControllerBase
{
    [HttpPost]
    [Authorize(Policy = "EST.Produto.Criar")]  // M√≥dulo.Tela.A√ß√£o
    public async Task&lt;IActionResult&gt; Create([FromBody] CreateProdutoCommand cmd)
    {
        // ...
    }
    
    [HttpDelete("{id}")]
    [Authorize(Policy = "EST.Produto.Excluir")]
    public async Task&lt;IActionResult&gt; Delete(Guid id)
    {
        // ...
    }
}</div>

            <h3>‚öôÔ∏è Configurar Policy-Based Authorization</h3>
            <div class="code-block">// Program.cs ou Startup.cs
builder.Services.AddAuthorization(options =>
{
    // Gera policies din√¢micas a partir das autoriza√ß√µes do banco
    var autorizacoes = GetAutorizacoesFromDb();
    foreach (var auth in autorizacoes)
    {
        options.AddPolicy(auth.Codigo, policy =>
            policy.RequireClaim("Autorizacao", auth.Codigo));
    }
});</div>

            <h3>‚úÖ Checklist de Seguran√ßa</h3>
            <div class="warning-box">
                <ul>
                    <li>‚òê Todos os endpoints sens√≠veis t√™m [Authorize]</li>
                    <li>‚òê Pol√≠ticas granulares por m√≥dulo/tela/a√ß√£o</li>
                    <li>‚òê JWT com expira√ß√£o curta (15-30 min)</li>
                    <li>‚òê Refresh token com rota√ß√£o</li>
                    <li>‚òê Rate limiting por usu√°rio/IP</li>
                    <li>‚òê Logs de auditoria para a√ß√µes cr√≠ticas</li>
                </ul>
            </div>
            <a class="back-to-top" href="#top">‚Üë Voltar ao topo</a>

            <h2>üìö Refer√™ncia</h2>
            <h3>üß© Componentes do Sistema</h3>
            
            <h3>1. Usu√°rio</h3>
            <div class="info-box">
                <p>Representa uma pessoa f√≠sica que acessa o sistema. Cada usu√°rio est√° vinculado a:</p>
                <ul>
                    <li>Uma <strong>Organiza√ß√£o</strong> (TenantId)</li>
                    <li>Um <strong>Perfil</strong> de acesso</li>
                    <li>Status (Ativo/Inativo/Bloqueado)</li>
                </ul>
            </div>
            
            <div class="code-block">public class Usuario : TenantEntityBase
{
    public string NomeCompleto { get; private set; }
    public string Email { get; private set; }
    public string SenhaHash { get; private set; }
    
    // Vincula√ß√£o ao perfil
    public Guid PerfilId { get; private set; }
    public virtual Perfil Perfil { get; private set; }
    
    // Controle de acesso
    public bool EmailVerificado { get; private set; }
    public bool Bloqueado { get; private set; }
    public int TentativasLogin { get; private set; }
    public DateTime? UltimoAcesso { get; private set; }
}</div>
            
            <h3>2. Perfil (Role)</h3>
            <div class="info-box">
                <p>Agrupa um conjunto de autoriza√ß√µes. Exemplos de perfis:</p>
                <ul>
                    <li><strong>Administrador:</strong> Acesso total ao sistema</li>
                    <li><strong>Gerente Financeiro:</strong> Acesso completo ao m√≥dulo FIN</li>
                    <li><strong>Operador de Vendas:</strong> Acesso limitado ao m√≥dulo VEN (criar pedidos, visualizar clientes)</li>
                    <li><strong>Auditor:</strong> Apenas visualiza√ß√£o (read-only) em todos os m√≥dulos</li>
                </ul>
                
                <p><strong>Heran√ßa de Perfis:</strong> Um perfil pode herdar autoriza√ß√µes de um perfil pai.</p>
            </div>
            
            <div class="code-block">public class Perfil : TenantEntityBase
{
    public string Nome { get; private set; }
    public string Descricao { get; private set; }
    
    // Heran√ßa de perfis
    public Guid? PerfilPaiId { get; private set; }
    public virtual Perfil? PerfilPai { get; private set; }
    
    // Relacionamento com autoriza√ß√µes
    public virtual ICollection<PerfilAutorizacao> Autorizacoes { get; private set; }
    
    public bool Ativo { get; private set; }
}</div>
            
            <h3>3. Autoriza√ß√£o (Permission)</h3>
            <div class="info-box">
                <p>Representa uma permiss√£o espec√≠fica no sistema. Cada autoriza√ß√£o possui:</p>
                <ul>
                    <li><strong>C√≥digo √önico:</strong> Ex: <code>ADM-USR-001</code>, <code>FIN-LAN-010</code></li>
                    <li><strong>M√≥dulo:</strong> ADM, SUP, FIN, VEN, etc</li>
                    <li><strong>Categoria:</strong> Usuario, Produto, NotaFiscal, etc</li>
                    <li><strong>Tipo de A√ß√£o:</strong> Visualizar, Criar, Editar, Excluir, Aprovar, Cancelar, Exportar</li>
                    <li><strong>Descri√ß√£o:</strong> Descri√ß√£o leg√≠vel da permiss√£o</li>
                </ul>
            </div>
            
            <div class="code-block">public class Autorizacao : EntityBase
{
    public string Codigo { get; private set; }          // Ex: ADM-USR-001
    public string Modulo { get; private set; }          // Ex: ADM
    public string Categoria { get; private set; }       // Ex: Usuario
    public string Descricao { get; private set; }       // Ex: Visualizar Usu√°rios
    public TipoAcao TipoAcao { get; private set; }     // Enum: Visualizar, Criar, Editar, etc
    public bool Ativo { get; private set; }
}

public enum TipoAcao
{
    Visualizar = 1,
    Criar = 2,
    Editar = 3,
    Excluir = 4,
    Aprovar = 5,
    Cancelar = 6,
    Exportar = 7,
    Importar = 8,
    Imprimir = 9
}</div>
            
            <h3>4. PerfilAutorizacao (Role-Permission Junction)</h3>
            <div class="info-box">
                <p>Tabela de relacionamento entre Perfil e Autoriza√ß√£o. Define se uma autoriza√ß√£o est√° <strong>Permitida</strong> ou <strong>Negada</strong> para um perfil espec√≠fico.</p>
            </div>
            
            <div class="code-block">public class PerfilAutorizacao : TenantEntityBase
{
    public Guid PerfilId { get; private set; }
    public virtual Perfil Perfil { get; private set; }
    
    public Guid AutorizacaoId { get; private set; }
    public virtual Autorizacao Autorizacao { get; private set; }
    
    // Permitir ou Negar
    public bool Permitir { get; private set; } = true;
}</div>
            
            <h2>üß™ Exemplos</h2>
            <h3>üîë Exemplos de Autoriza√ß√µes</h3>
            
            <h3>M√≥dulo Administra√ß√£o (ADM)</h3>
            <table>
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Categoria</th>
                        <th>Descri√ß√£o</th>
                        <th>Tipo A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>ADM-ORG-001</code></td>
                        <td>Organiza√ß√£o</td>
                        <td>Visualizar Organiza√ß√µes</td>
                        <td>Visualizar</td>
                    </tr>
                    <tr>
                        <td><code>ADM-ORG-002</code></td>
                        <td>Organiza√ß√£o</td>
                        <td>Criar Organiza√ß√£o</td>
                        <td>Criar</td>
                    </tr>
                    <tr>
                        <td><code>ADM-USR-001</code></td>
                        <td>Usu√°rio</td>
                        <td>Visualizar Usu√°rios</td>
                        <td>Visualizar</td>
                    </tr>
                    <tr>
                        <td><code>ADM-USR-002</code></td>
                        <td>Usu√°rio</td>
                        <td>Criar Usu√°rio</td>
                        <td>Criar</td>
                    </tr>
                    <tr>
                        <td><code>ADM-USR-003</code></td>
                        <td>Usu√°rio</td>
                        <td>Editar Usu√°rio</td>
                        <td>Editar</td>
                    </tr>
                    <tr>
                        <td><code>ADM-USR-004</code></td>
                        <td>Usu√°rio</td>
                        <td>Excluir Usu√°rio</td>
                        <td>Excluir</td>
                    </tr>
                    <tr>
                        <td><code>ADM-PER-001</code></td>
                        <td>Perfil</td>
                        <td>Visualizar Perfis</td>
                        <td>Visualizar</td>
                    </tr>
                    <tr>
                        <td><code>ADM-PER-002</code></td>
                        <td>Perfil</td>
                        <td>Criar Perfil</td>
                        <td>Criar</td>
                    </tr>
                    <tr>
                        <td><code>ADM-AUD-001</code></td>
                        <td>Auditoria</td>
                        <td>Visualizar Logs de Auditoria</td>
                        <td>Visualizar</td>
                    </tr>
                    <tr>
                        <td><code>ADM-AUD-007</code></td>
                        <td>Auditoria</td>
                        <td>Exportar Logs de Auditoria</td>
                        <td>Exportar</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>M√≥dulo Financeiro (FIN)</h3>
            <table>
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Categoria</th>
                        <th>Descri√ß√£o</th>
                        <th>Tipo A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>FIN-LAN-001</code></td>
                        <td>Lan√ßamento</td>
                        <td>Visualizar Lan√ßamentos</td>
                        <td>Visualizar</td>
                    </tr>
                    <tr>
                        <td><code>FIN-LAN-002</code></td>
                        <td>Lan√ßamento</td>
                        <td>Criar Lan√ßamento</td>
                        <td>Criar</td>
                    </tr>
                    <tr>
                        <td><code>FIN-LAN-005</code></td>
                        <td>Lan√ßamento</td>
                        <td>Aprovar Lan√ßamento</td>
                        <td>Aprovar</td>
                    </tr>
                    <tr>
                        <td><code>FIN-PAG-001</code></td>
                        <td>Pagamento</td>
                        <td>Visualizar Pagamentos</td>
                        <td>Visualizar</td>
                    </tr>
                    <tr>
                        <td><code>FIN-PAG-005</code></td>
                        <td>Pagamento</td>
                        <td>Aprovar Pagamento</td>
                        <td>Aprovar</td>
                    </tr>
                    <tr>
                        <td><code>FIN-REL-007</code></td>
                        <td>Relat√≥rio</td>
                        <td>Exportar Relat√≥rio Financeiro</td>
                        <td>Exportar</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>M√≥dulo Vendas (VEN)</h3>
            <table>
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Categoria</th>
                        <th>Descri√ß√£o</th>
                        <th>Tipo A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>VEN-CLI-001</code></td>
                        <td>Cliente</td>
                        <td>Visualizar Clientes</td>
                        <td>Visualizar</td>
                    </tr>
                    <tr>
                        <td><code>VEN-PED-001</code></td>
                        <td>Pedido</td>
                        <td>Visualizar Pedidos</td>
                        <td>Visualizar</td>
                    </tr>
                    <tr>
                        <td><code>VEN-PED-002</code></td>
                        <td>Pedido</td>
                        <td>Criar Pedido</td>
                        <td>Criar</td>
                    </tr>
                    <tr>
                        <td><code>VEN-PED-005</code></td>
                        <td>Pedido</td>
                        <td>Aprovar Pedido</td>
                        <td>Aprovar</td>
                    </tr>
                    <tr>
                        <td><code>VEN-PED-006</code></td>
                        <td>Pedido</td>
                        <td>Cancelar Pedido</td>
                        <td>Cancelar</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>üõ°Ô∏è Fluxo de Autentica√ß√£o e Autoriza√ß√£o</h3>
            
            <div class="warning-box">
                <h4>1. Autentica√ß√£o (Login)</h4>
                <ol>
                    <li>Usu√°rio fornece <code>email</code> e <code>senha</code></li>
                    <li>Sistema valida credenciais</li>
                    <li>Se v√°lido, gera <strong>JWT Token</strong> contendo:
                        <ul>
                            <li><code>userId</code></li>
                            <li><code>tenantId</code></li>
                            <li><code>perfilId</code></li>
                            <li><code>claims</code> com autoriza√ß√µes do usu√°rio</li>
                        </ul>
                    </li>
                    <li>Retorna <strong>Access Token</strong> (15 minutos) e <strong>Refresh Token</strong> (7 dias)</li>
                </ol>
            </div>
            
            <div class="success-box">
                <h4>2. Autoriza√ß√£o (Verifica√ß√£o de Permiss√µes)</h4>
                <ol>
                    <li>Requisi√ß√£o HTTP inclui token JWT no header: <code>Authorization: Bearer {token}</code></li>
                    <li>Middleware extrai <code>userId</code> e <code>tenantId</code> do token</li>
                    <li>Sistema busca autoriza√ß√µes do perfil do usu√°rio</li>
                    <li>Action Filter <code>[Authorize("ADM-USR-001")]</code> valida se usu√°rio possui a permiss√£o</li>
                    <li>Se autorizado, executa a a√ß√£o; caso contr√°rio, retorna <code>403 Forbidden</code></li>
                </ol>
            </div>
            
            <h3>üîß Implementa√ß√£o T√©cnica</h3>
            
            <h3>1. Authorization Attribute Customizado</h3>
            <div class="code-block">[AttributeUsage(AttributeTargets.Class | AttributeTargets.Method)]
public class AutorizacaoAttribute : AuthorizeAttribute, IAuthorizationFilter
{
    private readonly string _codigoAutorizacao;
    
    public AutorizacaoAttribute(string codigoAutorizacao)
    {
        _codigoAutorizacao = codigoAutorizacao;
    }
    
    public void OnAuthorization(AuthorizationFilterContext context)
    {
        var user = context.HttpContext.User;
        
        if (!user.Identity.IsAuthenticated)
        {
            context.Result = new UnauthorizedResult();
            return;
        }
        
        var hasPermission = user.HasClaim("autorizacao", _codigoAutorizacao);
        
        if (!hasPermission)
        {
            context.Result = new ForbidResult();
        }
    }
}</div>
            
            <h3>2. Uso em Controllers</h3>
            <div class="code-block">[ApiController]
[Route("api/v1/[controller]")]
public class UsuariosController : ControllerBase
{
    [HttpGet]
    [Autorizacao("ADM-USR-001")] // Visualizar Usu√°rios
    public async Task<IActionResult> ListarUsuarios()
    {
        // ...
    }
    
    [HttpPost]
    [Autorizacao("ADM-USR-002")] // Criar Usu√°rio
    public async Task<IActionResult> CriarUsuario([FromBody] CriarUsuarioCommand command)
    {
        // ...
    }
    
    [HttpPut("{id}")]
    [Autorizacao("ADM-USR-003")] // Editar Usu√°rio
    public async Task<IActionResult> AtualizarUsuario(Guid id, [FromBody] AtualizarUsuarioCommand command)
    {
        // ...
    }
    
    [HttpDelete("{id}")]
    [Autorizacao("ADM-USR-004")] // Excluir Usu√°rio
    public async Task<IActionResult> ExcluirUsuario(Guid id)
    {
        // ...
    }
}</div>
            
            <h3>3. JWT Token Generation</h3>
            <div class="code-block">public string GerarToken(Usuario usuario, List<string> autorizacoes)
{
    var claims = new List<Claim>
    {
        new Claim(ClaimTypes.NameIdentifier, usuario.Id.ToString()),
        new Claim("tenantId", usuario.TenantId.ToString()),
        new Claim("perfilId", usuario.PerfilId.ToString()),
        new Claim(ClaimTypes.Email, usuario.Email),
        new Claim(ClaimTypes.Name, usuario.NomeCompleto)
    };
    
    // Adicionar autoriza√ß√µes como claims
    foreach (var autorizacao in autorizacoes)
    {
        claims.Add(new Claim("autorizacao", autorizacao));
    }
    
    var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(_configuration["Jwt:Secret"]));
    var creds = new SigningCredentials(key, SecurityAlgorithms.HmacSha256);
    
    var token = new JwtSecurityToken(
        issuer: _configuration["Jwt:Issuer"],
        audience: _configuration["Jwt:Audience"],
        claims: claims,
        expires: DateTime.UtcNow.AddMinutes(15),
        signingCredentials: creds
    );
    
    return new JwtSecurityTokenHandler().WriteToken(token);
}</div>
            
            <h3>üìã Matriz de Autoriza√ß√µes por Perfil</h3>
            <div class="info-box">
                <p>Exemplo de configura√ß√£o de perfis:</p>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Autoriza√ß√£o</th>
                        <th>Administrador</th>
                        <th>Gerente</th>
                        <th>Operador</th>
                        <th>Auditor</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>ADM-USR-001</code> Visualizar Usu√°rios</td>
                        <td>‚úÖ</td>
                        <td>‚úÖ</td>
                        <td>‚ùå</td>
                        <td>‚úÖ</td>
                    </tr>
                    <tr>
                        <td><code>ADM-USR-002</code> Criar Usu√°rio</td>
                        <td>‚úÖ</td>
                        <td>‚úÖ</td>
                        <td>‚ùå</td>
                        <td>‚ùå</td>
                    </tr>
                    <tr>
                        <td><code>ADM-USR-004</code> Excluir Usu√°rio</td>
                        <td>‚úÖ</td>
                        <td>‚ùå</td>
                        <td>‚ùå</td>
                        <td>‚ùå</td>
                    </tr>
                    <tr>
                        <td><code>FIN-LAN-002</code> Criar Lan√ßamento</td>
                        <td>‚úÖ</td>
                        <td>‚úÖ</td>
                        <td>‚úÖ</td>
                        <td>‚ùå</td>
                    </tr>
                    <tr>
                        <td><code>FIN-LAN-005</code> Aprovar Lan√ßamento</td>
                        <td>‚úÖ</td>
                        <td>‚úÖ</td>
                        <td>‚ùå</td>
                        <td>‚ùå</td>
                    </tr>
                    <tr>
                        <td><code>VEN-PED-002</code> Criar Pedido</td>
                        <td>‚úÖ</td>
                        <td>‚úÖ</td>
                        <td>‚úÖ</td>
                        <td>‚ùå</td>
                    </tr>
                    <tr>
                        <td><code>VEN-PED-006</code> Cancelar Pedido</td>
                        <td>‚úÖ</td>
                        <td>‚úÖ</td>
                        <td>‚ùå</td>
                        <td>‚ùå</td>
                    </tr>
                </tbody>
            </table>
            
            <h3>üîí Seguran√ßa e Melhores Pr√°ticas</h3>
            <div class="warning-box">
                <ul>
                    <li>‚úÖ <strong>Princ√≠pio do Menor Privil√©gio:</strong> Usu√°rios devem ter apenas as permiss√µes necess√°rias</li>
                    <li>‚úÖ <strong>Auditoria Completa:</strong> Todas as opera√ß√µes sens√≠veis s√£o logadas</li>
                    <li>‚úÖ <strong>Token Expiration:</strong> Access tokens expiram em 15 minutos</li>
                    <li>‚úÖ <strong>Refresh Token Rotation:</strong> Refresh tokens s√£o rotacionados a cada uso</li>
                    <li>‚úÖ <strong>Bloqueio por Tentativas:</strong> Usu√°rio bloqueado ap√≥s 5 tentativas de login falhas</li>
                    <li>‚úÖ <strong>Valida√ß√£o em M√∫ltiplas Camadas:</strong> Frontend + API + Domain Layer</li>
                    <li>‚úÖ <strong>HTTPS Obrigat√≥rio:</strong> Toda comunica√ß√£o via TLS 1.3+</li>
                </ul>
            </div>
            
        </div>
        
        <div class="footer">
            <p><strong>ANYPRO - Sistema ERP Modular Multi-Tenant</strong></p>
            <p><a href="../index.html">Voltar ao Menu Principal</a></p>
        </div>
    </div>
    <script src="../js/toc.js" defer></script>
<script src="../js/section-nav.js" defer></script>
<script src="../js/nav-active.js" defer></script>
</body>
</html>
